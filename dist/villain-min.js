function $element(t){return t instanceof $?t:$(t)}var that=this,Villain;Villain=that.Villain={},Villain.EventBus=Villain.EventBus||_.extend({},Backbone.Events),Villain.Blocks=Villain.Blocks||{},Villain.Editor=Villain.Editor||{},Villain.options=Villain.options||[],Villain.defaults={textArea:"#textarea",browseURL:"villain/browse/",uploadURL:"villain/upload/",imageseriesURL:"villain/imageseries/"};var url_regex=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/;_.mixin({isURI:function(t){return url_regex.test(t)},titleize:function(t){return null===t?"":(t=String(t).toLowerCase(),t.replace(/(?:^|\s|-)\S/g,function(t){return t.toUpperCase()}))},classify:function(t){return _.titleize(String(t).replace(/[\W_]/g," ")).replace(/\s/g,"")},classifyList:function(t){return _.map(t,function(t){return _.classify(t)})},capitalize:function(t){return t.charAt(0).toUpperCase()+t.substring(1).toLowerCase()},underscored:function(t){return _.trim(t).replace(/([a-z\d])([A-Z]+)/g,"$1_$2").replace(/[-\s]+/g,"_").toLowerCase()},trim:function(t){return t.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},reverse:function(t){return t.split("").reverse().join("")},flattern:function(t){var e={};return _.each(t,function(i,a){e[_.isArray(t)?i:a]=!0}),e},to_slug:function(t){return t.toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")}}),$.fn.visible=function(){return this.css("visibility","visible")},$.fn.invisible=function(){return this.css("visibility","hidden")},$.fn.visibilityToggle=function(){return this.css("visibility",function(t,e){return"visible"==e?"hidden":"visible"})},$.fn.caretToEnd=function(){var t,e;return t=document.createRange(),t.selectNodeContents(this[0]),t.collapse(!1),e=window.getSelection(),e.removeAllRanges(),e.addRange(t),this},$.fn.flash=function(t,e){t=t||1e3,e=e||2;var i=Math.floor(t/e);originalColor=this.css("background-color"),this.css("background-color","#ffffdd");for(var a=0;e>a;a++)this.fadeOut(i).fadeIn(i,function(){this.css("background-color","#ffffff")});return this},$.fn.shake=function(t,e,i){return t=t||3,e=e||10,i=i||300,this.each(function(){$(this).css("position","relative");for(var a=1;t>=a;a++)$(this).animate({left:-1*e},i/t/4).animate({left:e},i/t/2).animate({left:0},i/t/4)}),this},function(t){"use strict";var e={init:function(e){var i=t.extend({},t.fn.loadingOverlay.defaults,e),a=t(this).addClass(i.loadingClass),n='<div class="'+i.overlayClass+'"><p class="'+i.spinnerClass+'"><span class="'+i.iconClass+'"></span><span class="'+i.textClass+'">'+i.loadingText+"</span></p></div>";return a.data("loading-overlay")||a.prepend(t(n)).data("loading-overlay",!0),a},remove:function(e){var i=t.extend({},t.fn.loadingOverlay.defaults,e),a=t(this).data("loading-overlay",!1);return a.find("."+i.overlayClass).detach(),a.hasClass(i.loadingClass)?a.removeClass(i.loadingClass):a.find("."+i.loadingClass).removeClass(i.loadingClass),a},exposeMethods:function(){return e}};t.fn.loadingOverlay=function(i){return e[i]?e[i].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof i&&i?void t.error("Method "+i+" does not exist on jQuery.loadingOverlay"):e.init.apply(this,arguments)},t.fn.loadingOverlay.defaults={loadingClass:"loading",overlayClass:"loading-overlay",spinnerClass:"loading-spinner",iconClass:"loading-icon fa fa-circle-o-notch fa-spin",textClass:"loading-text",loadingText:""}}(jQuery),Villain.Plus=Backbone.View.extend({tagName:"div",className:"villain-add-block villain-droppable",blockSelectionTemplate:_.template('<div class="villain-block-selection"><%= content %></div>'),events:{"click .villain-add-block-button":"onClickAddBlock","click .villain-block-button":"onClickBlockButton"},initialize:function(t){this.store=t,this.$el.attr("data-blockstore",t),this.$el.attr("id",_.uniqueId("villain-plus-")),this.render()},render:function(){return this.$el.append('<button class="villain-add-block-button">+</button>'),this},onClickBlockButton:function(t){t.preventDefault(),$button=$(t.currentTarget),blockType=$button.data("type"),blockStore=this.store,BlockClass=Villain.BlockRegistry.getBlockClassByType(blockType),block=new BlockClass(!1,blockStore),block.$el.insertAfter($button.parent().parent()),block.$el.after(block.renderPlus().$el),block.hasTextBlock()&&block.setCaret(),block.scrollTo(),$button.parent().prev().show(),$button.parent().remove()},onClickAddBlock:function(t){t.preventDefault(),$addBlockButton=$(t.currentTarget),$addBlockButton.hide(),blockId=$addBlockButton.parent().data("after-block-id"),blockSelection=this.blockSelectionTemplate({content:this.getButtons(blockId)}),$addBlockButton.parent().append(blockSelection)},getButtons:function(t){for(html="",i=0;i<Villain.BlockRegistry.Map.length;++i)blockName=Villain.BlockRegistry.Map[i],b=Villain.BlockRegistry.getBlockClassByType(blockName),_.isUndefined(b)?console.error("Villain: Undefined block ",blockName):b.hasOwnProperty("getButton")?html+=b.getButton(t):console.log("// No button found for "+blockName);return html}}),Villain.BlockStore=[],Villain.BlockStore.stores=[],Villain.BlockStore.count=1,Villain.BlockStore.getId=function(){return id=Villain.BlockStore.count,Villain.BlockStore.count++,id},Villain.BlockStore.getBlockById=function(t,e){return block=_.find(Villain.BlockStore[t],function(t){return t.id==e}),block&&block.hasOwnProperty("object")?block.object:!1},Villain.BlockStore.add=function(t,e,i){Villain.BlockStore[t].push({id:e,object:i})},Villain.BlockStore.del=function(t,e){Villain.BlockStore[t]=_.filter(Villain.BlockStore[t],function(t){return parseInt(t.id)!==parseInt(e)})},Villain.BlockStore.delStore=function(t){_.each(Villain.BlockStore[t],function(t){t.object.destroy()}),Villain.BlockStore[t]=[];var e=Villain.BlockStore.stores.indexOf(t);Villain.BlockStore.stores.splice(e,1)},Villain.BlockStore.create=function(t){Villain.BlockStore[t]=[],Villain.BlockStore.stores.push(t)},Villain.BlockStore.listAll=function(){for(var t=0;t<Villain.BlockStore.stores.length;t++)console.log(Villain.BlockStore.stores[t]),console.log(Villain.BlockStore[Villain.BlockStore.stores[t]])},Villain.Block=Backbone.View.extend({tagName:"div",className:"villain-block-wrapper",type:"base",template:_.template("base"),store:"main",wrapperTemplate:_.template(['<div class="villain-block-inner"><%= content %><%= actions %></div>'].join("\n")),actionsTemplate:_.template(['<div class="villain-actions">','  <div class="villain-action-button villain-action-button-setup">','    <i class="fa fa-cogs"></i>',"  </div>",'  <div class="villain-action-button villain-action-button-del">','    <i class="fa fa-trash"></i>',"  </div>",'  <div class="villain-action-button villain-action-button-move" draggable="true">','    <i class="fa fa-arrows-alt"></i>',"  </div>","</div>"].join("\n")),setupTemplate:_.template('<div class="villain-setup-block" />'),events:{"dragstart .villain-action-button-move":"onDragStart","click .villain-action-button-move":"onClickMove","click .villain-action-button-del":"onClickDelete","mouseover .villain-block-inner":"onMouseOver","mouseout .villain-block-inner":"onMouseOut","paste .villain-text-block":"onPaste","mouseup .villain-text-block":"onMouseUp","keyup .villain-text-block":"onKeyUp","click .villain-text-block":"onClick","click .villain-action-button-setup":"onSetupClick"},initialize:function(t,e){this.data=t||null,this.dataId=this.getIdFromBlockStore(),this.$el.attr("data-block-id",this.dataId),this.$el.attr("data-block-type",this.type),this.$el.attr("id","villain-block-"+this.dataId),e&&(this.store=e),this.$el.attr("data-blockstore",this.store),this.id="villain-block-"+this.dataId,this.addToBlockStore(e),this.render(),this.afterRenderCallback&&this.afterRenderCallback()},render:function(){return html=this.hasData()?this.renderEditorHtml():this.renderEmpty(),this.el.innerHTML=html,this.setSections(),this.addSetup(),this},onClick:function(){var t=this.getSelectedText();""===t&&Villain.EventBus.trigger("formatpopup:hide")},onSetupClick:function(t){t.stopPropagation(),$button=this.$(".villain-action-button-setup"),$button.hasClass("active")?($button.removeClass("active"),this.hideSetup()):($button.addClass("active"),this.showSetup())},onKeyUp:function(){var t=this.getSelectedText();""!==t?Villain.EventBus.trigger("formatpopup:show",this):Villain.EventBus.trigger("formatpopup:hide")},onMouseUp:function(){var t=this.getSelectedText();""!==t?Villain.EventBus.trigger("formatpopup:show",this):Villain.EventBus.trigger("formatpopup:hide")},getSelectedText:function(){var t="";return window.getSelection?t=window.getSelection():document.getSelection?t=document.getSelection():document.selection&&(t=document.selection.createRange().text),t.toString()},deleteBlock:function(){Villain.BlockStore.del(this.store,this.dataId),this.destroy()},loading:function(){this.$el.loadingOverlay()},done:function(){this.$el.loadingOverlay("remove")},addToPathName:function(t){if("/"===t.charAt(0))return t;var e="/"==window.location.pathname.slice(-1)?"":"/",i=window.location.pathname+e+t;return i},destroy:function(){this.$el.next(".villain-add-block").remove(),this.undelegateEvents(),this.$el.removeData().unbind(),this.remove(),Backbone.View.prototype.remove.call(this)},onClickDelete:function(t){this.deleteBlock(),t.stopPropagation()},onClickMove:function(t){t.stopPropagation()},onDragStart:function(t){t.originalEvent.dataTransfer.setDragImage(this.$el.get(0),this.$el.width(),this.$el.height()),t.originalEvent.dataTransfer.setData("Text",this.dataId),t.stopPropagation()},onMouseOver:function(){event.stopPropagation(),this.$inner.addClass("hover"),this.$inner.children(".villain-actions").visible()},onMouseOut:function(){this.$inner.removeClass("hover"),this.$inner.children(".villain-actions").invisible()},onPaste:function(t){var e=!1;if(t&&t.originalEvent.clipboardData&&t.originalEvent.clipboardData.getData){var i="",a=t.originalEvent.clipboardData.types;if($.isArray(a))for(var n=0;n<a.length;n++)i+=a[n]+";";else i=a;if(/text\/html/.test(i)?clipboardHTML=t.originalEvent.clipboardData.getData("text/html"):/text\/rtf/.test(i)&&Villain.browser.safari?clipboardHTML=t.originalEvent.clipboardData.getData("text/rtf"):/text\/plain/.test(i)&&!Villain.browser.mozilla&&(clipboardHTML=t.originalEvent.clipboardData.getData("text/plain").replace(/\n/g,"<br/>")),""!==this.clipboardHTML?e=!0:this.clipboardHTML=null,e)return cleanHtml=Villain.Editor.processPaste(clipboardHTML),t.stopPropagation(),t.preventDefault(),Villain.Editor.pasteHtmlAtCaret(cleanHtml),!1}},getIdFromBlockStore:function(){return Villain.BlockStore.getId()},doRenderCallback:function(){},hasTextBlock:function(){return 0===this.$(".villain-text-block").length?!1:!0},setCaret:function(){var t,e;t=document.createRange(),t.selectNodeContents(this.getTextBlock()[0]),t.collapse(!1),e=window.getSelection(),e.removeAllRanges(),e.addRange(t)},scrollTo:function(){$("html, body").animate({scrollTop:this.$el.offset().top-75},300,"linear")},flash:function(){},getJSON:function(){return[]},addToBlockStore:function(t){Villain.BlockStore.add(t?t:"main",this.dataId,this)},setData:function(t){this.data=t},getData:function(){return this.data},setDataProperty:function(t,e){data=this.getData(),data[t]=e,this.setData(data)},hasData:function(){return this.data?!_.isEmpty(this.data):!1},refreshBlock:function(){return html=this.renderEditorHtml(),this.el.innerHTML=html,this.addSetup(),this},refreshContentBlock:function(){return block=this.renderContentBlockHtml(),this.$content.html($(block).html()),this.$content},setSections:function(){this.$inner=this.$(".villain-block-inner"),this.$content=this.$(".villain-content")},addSetup:function(){this.setup?(this.$inner.prepend(this.setupTemplate()),this.$setup=this.$(".villain-setup-block"),this.$(".villain-action-button-setup").show(),this.setup()):this.$(".villain-action-button-setup").hide()},clearSetup:function(){this.$setup.empty()},getTextBlock:function(){return this.$textBlock=this.$(".villain-text-block"),this.$textBlock},getTextBlockInner:function(){return tb=this.getTextBlock(),tb.html()},clearInsertedStyles:function(t){var e=t.target;e.removeAttribute("style")},renderEditorHtml:function(){},renderEmpty:function(){},renderPlus:function(){return addblock=new Villain.Plus(this.store)},showSetup:function(){innerHeight=this.$inner.height(),innerWidth=this.$inner.width(),this.$content.hide(),$button=this.$(".villain-action-button-setup"),$button.addClass("active"),this.$setup.show(),this.$setup.height()<innerHeight&&this.$setup.height(innerHeight),300>innerWidth&&this.$el.width(300)},hideSetup:function(){this.$setup.hide(),this.$setup.height(""),$button=this.$(".villain-action-button-setup"),$button.removeClass("active"),this.$content.show()}}),Villain.Blocks.Text=Villain.Block.extend({type:"text",template:_.template('<div class="villain-text-block villain-content" contenteditable="true" data-text-type="<%= type %>"><%= content %></div>'),renderEditorHtml:function(){return blockTemplate=this.renderContentBlockHtml(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderContentBlockHtml:function(){return text=this.getTextBlockInner()?this.getTextBlockInner():this.data.text,this.template({content:Villain.toHTML(text),type:this.data.type})},renderEmpty:function(){return blockTemplate=this.template({content:"Text",type:"paragraph"}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return textNode=Villain.toMD(this.getTextBlockInner()),data=this.getData(),json={type:this.type,data:{text:textNode,type:data.type}}},getHTML:function(){return textNode=this.getTextBlock().html(),markdown.toHTML(textNode)},setup:function(){data=this.getData(),data.hasOwnProperty("type")||this.setDataProperty("type","paragraph"),type=this.data.type,this.$setup.hide();var t="";types=["paragraph","lead"];for(i in types)selected="",type===types[i]&&(selected=' checked="checked"'),t+='<label><input type="radio" name="text-type" value="'+types[i]+'"'+selected+">"+types[i]+"</label>";this.$setup.append($(["<label>Type</label>",t].join("\n"))),this.$setup.find("input[type=radio]").on("change",$.proxy(function(t){this.setDataProperty("type",$(t.target).val()),this.refreshContentBlock(),this.$content.attr("data-text-type",$(t.target).val())},this))}},{getButton:function(e){var i="text";return(t=_.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-paragraph"></i>',"<p>text</p>","</button>"].join("\n")))({id:e,type:i})}}),Villain.Blocks.Blockquote=Villain.Block.extend({type:"blockquote",template:_.template('<div class="villain-quote-block villain-content"><blockquote contenteditable="true"><%= content %></blockquote><cite contenteditable="true"><%= cite %></cite></div>'),renderEditorHtml:function(){return blockTemplate=this.renderContentBlockHtml(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderContentBlockHtml:function(){return text=this.getTextBlockInner()?this.getTextBlockInner():this.data.text,this.template({content:Villain.toHTML(text),cite:this.data.cite})},renderEmpty:function(){return blockTemplate=this.template({content:"quote",cite:"author"}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return quote=this.$content.find("blockquote")[0].outerHTML,cite=$("cite",this.$content).html(),textNode=Villain.toMD(quote),data=this.getData(),json={type:this.type,data:{text:textNode,cite:cite}}},getHTML:function(){return textNode=this.getTextBlock().html(),markdown.toHTML(textNode)}},{getButton:function(e){var i="blockquote";return(t=_.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-quote-right"></i>',"<p>quote</p>","</button>"].join("\n")))({id:e,type:i})}}),Villain.Blocks.Divider=Villain.Block.extend({type:"divider",template:_.template('<div class="villain-divider-block villain-content"><hr></div>'),renderEditorHtml:function(){return blockTemplate=this.template(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderEmpty:function(){return blockTemplate=this.template(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return json={type:this.type,data:{text:"--------------------"}}},getHTML:function(){return"<hr>"}},{getButton:function(e){var i="divider";return(t=_.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-minus"></i>',"<p>hr</p>","</button>"].join("\n")))({id:e,type:i})}}),Villain.Blocks.Header=Villain.Block.extend({type:"header",template:_.template(['<div class="villain-text-block villain-text-block-header villain-content" data-header-level="<%= level %>" contenteditable="true">',"<%= content %>","</div>"].join("\n")),renderEditorHtml:function(){return blockTemplate=this.renderContentBlockHtml(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderContentBlockHtml:function(){return this.template({content:this.data.text,level:this.data.level})},renderEmpty:function(){return blockTemplate=this.template({content:"Header",level:1}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},setup:function(){data=this.getData(),data.hasOwnProperty("level")||this.setDataProperty("level",1),level=data.level,anchor=data.anchor||"",this.$setup.hide();var t="";levels=[1,2,3,4,5];for(i in levels)selected="",parseInt(level)===parseInt(levels[i])&&(selected=' checked="checked"'),t+='<label><input type="radio" name="header-size-'+this.dataId+'" value="'+levels[i]+'"'+selected+">H"+levels[i]+"</label>";this.$setup.append($(["<label>Størrelse</label>",t].join("\n"))),this.$setup.append($(["<br /><label>Anker</label>",'<input type="text" value="'+anchor+'" name="header-anchor-'+this.dataId+'" />'].join("\n"))),this.$setup.find("input[type=text]").on("keyup",$.proxy(function(t){this.setDataProperty("anchor",$(t.target).val())},this)),this.$setup.find("input[type=radio]").on("change",$.proxy(function(t){this.setDataProperty("level",$(t.target).val()),this.refreshContentBlock(),this.$content.attr("data-header-level",$(t.target).val())},this))},getData:function(){return data=this.data,data.text=Villain.toMD(this.getTextBlock().html()).trim(),data},getJSON:function(){return json={type:this.type,data:this.getData()}},getHTML:function(){return textNode=this.getTextBlock().html(),"<h3>"+markdown.toHTML(textNode)+"</h3>"}},{getButton:function(e){var i="header";return(t=_.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-header"></i>',"<p>h1-6</p>","</button>"].join("\n")))({id:e,type:i})}}),Villain.Blocks.List=Villain.Block.extend({type:"list",template:_.template(['<div class="villain-text-block villain-text-block-list villain-content" contenteditable="true">',"<%= content %>","</div>"].join("\n")),events:{"keyup .villain-content":"onKeyUp"},onKeyUp:function(t){console.log(t.currentTarget.innerHTML),(""==t.currentTarget.innerText||"\n"==t.currentTarget.innerText)&&(console.log("empty!"),t.currentTarget.innerHTML="<ul><li><br></li></ul>")},renderEditorHtml:function(){return blockTemplate=this.template({content:markdown.toHTML(this.data.text)}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderEmpty:function(){return blockTemplate=this.template({content:"<ul><li>list</li></ul>"}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return textNode=this.getTextBlock().html().replace(/<\/li>/gm,"\n").replace(/<\/?[^>]+(>|$)/g,"").replace(/^(.+)$/gm," - $1"),json={type:this.type,data:{text:textNode}}},getHTML:function(){return textNode=this.getTextBlock().html(),"<h3>"+markdown.toHTML(textNode)+"</h3>"},toMarkdown:function(t){return t.replace(/<\/li>/gm,"\n").replace(/<\/?[^>]+(>|$)/g,"").replace(/^(.+)$/gm," - $1")}},{getButton:function(e){var i="list";return(t=_.template(['<button class="villain-block-button" ','        data-type="<%= type %>" ','        data-after-block-id="<%= id %>"',">",'   <i class="fa fa-list-ul"></i>',"<p>list</p>","</button>"].join("\n")))({id:e,type:i})}}),Villain.Blocks.Image=Villain.Block.extend({type:"image",template:_.template('<div class="villain-image-block villain-content"><img class="img-responsive" src="<%= url %>" /></div>'),events:{"drop .villain-image-dropper i":"onDropImage","dragenter .villain-image-dropper i":"onDragEnter","dragleave .villain-image-dropper i":"onDragLeave","dragover .villain-image-dropper i":"onDragOver","click .villain-image-dropper-upload":"onUploadClickAfterDrop"},initialize:function(t,e){Villain.Block.prototype.initialize.apply(this,[t,e]),_.extend(this.events,Villain.Block.prototype.events)},renderEditorHtml:function(){return blockTemplate=this.renderContentBlockHtml(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderContentBlockHtml:function(){return this.template({url:this.data.url})},renderEmpty:function(){return blockTemplate=this.template({url:"http://placehold.it/1150x400"}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},onUploadClickAfterDrop:function(t){var e=[this.dataId,(new Date).getTime(),"raw"].join("-"),i=new FormData;return t.preventDefault(),this.loading(),img=this.$setup.find(".villain-image-dropper img"),this.file?(i.append("name",this.file.name),i.append("image",this.file),i.append("uid",e),that=this,$.ajax({type:"post",dataType:"json",accepts:{json:"text/json"},url:this.addToPathName(Villain.options.uploadURL),data:i,cache:!1,contentType:!1,processData:!1,xhr:function(){var t=$.ajaxSettings.xhr();return t.upload&&t.upload.addEventListener("progress",that.progressHandlingFunction,!1),t}}).done($.proxy(function(t){if("200"==t.status&&(this.$setup.append('<div class="villain-message success">Bildet er lastet opp</div>'),this.$setup.find(".villain-image-dropper-upload").remove(),this.$setup.find(".villain-image-dropper").remove(),t.hasOwnProperty("image")&&(imageData=t.image,$image=$('<img src="'+imageData.src+'" />'),this.$setup.append($image),json={url:imageData.src,sizes:imageData.sizes},this.setData(json)),t.hasOwnProperty("uid")&&(e=t.uid),t.hasOwnProperty("form"))){var i="";inputTemplate=_.template(["<label><%= label %></label>",'<input type="<%= type %>" ','       value="<%= value %>" ','       name="<%= name %>"',"/>"].join("\n"));for(var a=0;a<t.form.fields.length;a++)field=t.form.fields[a],i+=inputTemplate({label:field.label,type:field.type,value:field.value,name:field.name});formTemplate=_.template(['<form method="<%= method %>" ','      action="<%= action %>" ','      class="villain-form" ','      name="<%= name %>"',">","<%= inputs %>","</form>"].join("\n")),form=formTemplate({method:t.form.method,action:that.addToPathName(t.form.action),name:t.form.name,inputs:i}),$form=$(form),$submitButton=$('<input type="submit" name="'+t.form.name+'-submit" value="Lagre" />'),$submitButton.on("click",function(i){i.preventDefault(),serializedForm=$form.serialize(),imagedata=new FormData,imagedata.append("form",serializedForm),imagedata.append("uid",e),$.ajax({type:"post",url:that.addToPathName(t.form.action),data:imagedata,cache:!1,contentType:!1,processData:!1,dataType:"json"}).done($.proxy(function(t){200==t.status&&(json=that.getData(),json.title=t.title,json.credits=t.credits,json.link="",that.setData(json),that.refreshContentBlock(),that.hideSetup(),that.setup())},this))}),$form.append($submitButton),this.$setup.append($form)}},this)).fail($.proxy(function(){alert("Feil fra server under opplasting.")},this)).always($.proxy(function(){})),void this.done()):(this.done(),!1)},progressHandlingFunction:function(t){t.lengthComputable},onDragEnter:function(t){this.$(".villain-image-dropper i").addClass("drop-hover"),t.preventDefault()},onDragLeave:function(t){this.$(".villain-image-dropper i").removeClass("drop-hover"),t.preventDefault()},onDragOver:function(t){t.preventDefault()},onDropImage:function(t){t.preventDefault(),this.$(".villain-image-dropper i").removeClass("drop-hover"),dataTransfer=t.originalEvent.dataTransfer;var e=dataTransfer.files[0],i="undefined"!=typeof URL?URL:"undefined"!=typeof webkitURL?webkitURL:null;/image/.test(e.type)&&(this.$(".villain-image-dropper").html($("<img>",{src:i.createObjectURL(e)})),$form=$(['<form enctype="multipart/form-data" ','encoding="multipart/form-data" action="upload/image" ','method="post" id="villain-upload-form-'+this.dataId+'">','<input id="villain-upload-file-'+this.dataId+'" ','type="file" ','name="villain-upload-file-'+this.dataId+'" ','accept="image/*">',"</form>"].join("\n")),this.$setup.append("<hr>"),this.$setup.append('<button class="villain-image-dropper-upload">Last opp og lagre</button>'),this.file=e)},getJSON:function(){return data=this.getData(),json={type:this.type,data:{url:data.url,sizes:data.sizes,title:data.title||"",credits:data.credits||"",link:data.link||""}}},getHTML:function(){return url=this.$("img").attr("src"),this.template({url:url})},setup:function(){if(this.hasData()){this.clearSetup(),data=this.getData(),$form=$('<form name="image-meta-'+this.dataId+'">'),$meta=$(['<label for="title">Tittel</label><input value="'+data.title+'" type="text" name="title" />','<label for="credits">Kreditering</label><input value="'+data.credits+'" type="text" name="credits" />','<label for="link">URL</label><input value="'+data.link+'" type="text" name="link" />'].join("\n")),$form.append($meta),$form.append($("<label>Størrelse</label>"));for(var t in data.sizes)data.sizes.hasOwnProperty(t)&&(checked="",data.sizes[t]==data.url&&(checked=' checked="checked"'),$radio=$('<label for="'+t+'"><input type="radio" name="imagesize" value="'+data.sizes[t]+'"'+checked+" />"+t+"</label>"),$form.append($radio));this.$setup.append($form),this.$setup.find('input[name="title"]').on("keyup",_.debounce($.proxy(function(t){this.setDataProperty("title",$(t.target).val())},this),700,!1)),this.$setup.find('input[name="credits"]').on("keyup",_.debounce($.proxy(function(t){this.setDataProperty("credits",$(t.target).val())},this),700,!1)),this.$setup.find('input[name="link"]').on("keyup",_.debounce($.proxy(function(t){this.setDataProperty("link",$(t.target).val())},this),700,!1)),this.$setup.find("input[type=radio]").on("change",$.proxy(function(t){this.setUrl($(t.target).val())},this)),this.hideSetup()}else this.$(".villain-image-block").hide(),$imageDropper=$(['<div class="villain-image-dropper"><i class="fa fa-image"></i>',"<div>Dra bildet du vil laste opp hit</div>","<div><hr></div>","<div>",'<button class="villain-image-browse-button">Hent bilde fra server</button>',"</div>","</div>"].join("\n")),$imageDropper.find(".villain-image-browse-button").on("click",$.proxy(this.onImageBrowseButton,this)),this.$setup.append($imageDropper),this.$setup.show()},setUrl:function(t){this.setDataProperty("url",t),this.refreshContentBlock()},onImageBrowseButton:function(t){t.preventDefault(),this.loading(),$.ajax({type:"get",url:this.addToPathName(Villain.options.browseURL),cache:!1,contentType:!1,processData:!1,dataType:"json"}).done($.proxy(function(t){if(200!=t.status)return alert("Ingen bilder fantes."),this.done(),!1;if(!t.hasOwnProperty("images"))return!1;$images=$("<div />");for(var e=0;e<t.images.length;e++)img=t.images[e],$store_img=$('<img src="'+img.thumb+'" />'),$store_img.data("sizes",img.sizes).data("large",img.src).data("title",img.title).data("credits",img.credits),$images.append($store_img);$images.on("click","img",$.proxy(function(e){this.setData({url:$(e.target).data("large"),title:$(e.target).data("title"),credits:$(e.target).data("credits"),sizes:$(e.target).data("sizes")}),t=this.getData(),this.refreshContentBlock(),this.hideSetup(),this.setup()},this)),this.$setup.html(""),this.$setup.append('<div class="villain-message success">Klikk på bildet du vil sette inn</div>'),this.$setup.append($images),this.done()},this))},onUploadImagesButton:function(t){var e=t.target.files,i="undefined"!=typeof URL?URL:"undefined"!=typeof webkitURL?webkitURL:null;fileList=[];for(var a=0;a<e.length;a++){var n=e[a];fileList.push(['<div class="three">','<div class="center-cropped" style="background-image: url(',i.createObjectURL(n),');"></div>',"</div>"].join("\n"))}listHTML='<div style="margin-top: 10px;" class="wrapper"><div class="row">';for(var l=0;l<fileList.length;l++)listHTML+=l&&l%4===0?'</div><div style="margin-top: 15px" class="row">'+fileList[l]:fileList[l];listHTML+="</div></div>",this.$setup.append(listHTML)}},{getButton:function(e){var i="image";return(t=_.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-file-image-o"></i>',"<p>img</p>","</button>"].join("\n")))({id:e,type:i})}}),Villain.Blocks.Slideshow=Villain.Block.extend({type:"slideshow",template:_.template(['<div class="villain-slideshow-block villain-content" contenteditable="false">',"<h4>Slideshow</h4>","<%= content %>","</div>"].join("\n")),renderEditorHtml:function(){return blockTemplate=this.renderContentBlockHtml(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderContentBlockHtml:function(){return images=this.renderDataImages(),this.template({content:images})},renderDataImages:function(){var t=this.getData();if(_.isUndefined(t.images))return"";for(var e="",i=0;i<t.images.length;i++)img=t.images[i],e+='<img src="'+t.media_url+"/"+img.sizes.thumb+'" />';return e},renderEmpty:function(){return blockTemplate=this.template({content:'<i class="fa fa-th"></i>'}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getAllImageseries:function(){that=this,$select=this.$setup.find(".imageserie-select"),$.ajax({type:"get",dataType:"json",accepts:{json:"text/json"},url:this.addToPathName(Villain.options.imageseriesURL),cache:!1,contentType:!1,processData:!1,xhr:function(){var t=$.ajaxSettings.xhr();return t.upload&&t.upload.addEventListener("progress",that.progressHandlingFunction,!1),t}}).done($.proxy(function(t){"200"==t.status&&($select.append(that.buildOptions(t.series,!0)),_.isUndefined(that.data.imageseries)||$select.val(that.data.imageseries).change())}))},getImageseries:function(t){$.ajax({type:"get",dataType:"json",accepts:{json:"text/json"},url:this.addToPathName(Villain.options.imageseriesURL),data:{series:t},cache:!1,contentType:!1,xhr:function(){var t=$.ajaxSettings.xhr();return t.upload&&t.upload.addEventListener("progress",that.progressHandlingFunction,!1),t}}).done($.proxy(function(t){if("200"==t.status){var e={};if(e.imageseries=t.series,e.media_url=t.media_url,e.images=t.images,that.$setup.find(".imageserie-size-select").length>0);else{var i='<label for="imageserie-size">Str:</label><select class="imageserie-size-select"         name="imageserie-size"></select>';that.$setup.append(i)}var a=that.$setup.find(".imageserie-size-select");a.html(""),a.append(that.buildOptions(t.sizes,!0)),_.isUndefined(that.data.size)||(a.val(that.data.size).change(),e.size=that.data.size),a.on("change",function(){e.size=$(this).val(),that.hideSetup()}),that.setData(e),that.refreshContentBlock()}}))},buildOptions:function(t,e){html=e?'<option disabled="disabled" selected="selected">---</option>':"";
for(var i=0;i<t.length;i++)val=t[i],html+='<option value="'+val+'">'+val+"</option>";return html},setup:function(){if(this.hasData()){this.$setup.hide();var t='<select class="imageserie-select" name="imageserie"></select>';this.$setup.append($(['<label for="imageserie">Bildeserie</label>',t].join("\n"))),$select=this.$setup.find(".imageserie-select"),$select.on("change",function(){that.getImageseries($(this).val())}),this.getAllImageseries()}else{this.$content.hide(),that=this,data=this.getData();var t='<select class="imageserie-select" name="imageserie"></select>';this.$setup.append($(['<label for="imageserie">Bildeserie</label>',t].join("\n"))),$select=this.$setup.find(".imageserie-select"),$select.on("change",function(){that.getImageseries($(this).val())}),this.getAllImageseries()}},getData:function(){return data=this.data},getJSON:function(){var t=this.getData();return delete t.images,delete t.media_url,json={type:this.type,data:t}},getHTML:function(){return textNode=this.getTextBlock().html(),"<h3>"+markdown.toHTML(textNode)+"</h3>"}},{getButton:function(e){var i="slideshow";return(t=_.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-th"></i>',"<p>slides</p>","</button>"].join("\n")))({id:e,type:i})}}),Villain.Blocks.Video=Villain.Block.extend({type:"video",providers:{vimeo:{regex:/(?:http[s]?:\/\/)?(?:www.)?vimeo.com\/(.+)/,html:['<iframe src="{{protocol}}//player.vimeo.com/video/{{remote_id}}?title=0&byline=0" ','width="580" height="320" frameborder="0"></iframe>'].join("\n")},youtube:{regex:/(?:http[s]?:\/\/)?(?:www.)?(?:(?:youtube.com\/watch\?(?:.*)(?:v=))|(?:youtu.be\/))([^&].+)/,html:['<iframe src="{{protocol}}//www.youtube.com/embed/{{remote_id}}" ','width="580" height="320" frameborder="0" allowfullscreen></iframe>'].join("\n")}},template:_.template('<div class="villain-video-block villain-content"><%= content %></div>'),events:{"click .villain-setup-block button":"onClick"},onClick:function(t){t.preventDefault(),videoUrl=this.$(".villain-video-setup-url").val(),_.isURI(videoUrl)&&(embedString=this.buildString(videoUrl),this.$content.html(embedString),this.hideSetup())},buildString:function(t){var e,i;if(_.each(this.providers,function(a,n){e=a.regex.exec(t),null===e||_.isUndefined(e[1])||(i={source:n,remote_id:e[1]},this.setData(i))},this),this.providers.hasOwnProperty(i.source)){var a=this.providers[i.source].html.replace("{{protocol}}",window.location.protocol).replace("{{remote_id}}",i.remote_id).replace("{{width}}","100%");return a}},initialize:function(t,e){Villain.Block.prototype.initialize.apply(this,[t,e]),_.extend(this.events,Villain.Block.prototype.events)},renderEditorHtml:function(){if(this.providers.hasOwnProperty(this.data.source)){var t=this.providers[this.data.source].html.replace("{{protocol}}",window.location.protocol).replace("{{remote_id}}",this.data.remote_id).replace("{{width}}","100%");return blockTemplate=this.template({content:t}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})}},renderEmpty:function(){return blockTemplate=this.template({content:""}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return url=this.$("img").attr("src"),json={type:this.type,data:this.data}},getHTML:function(){return url=this.$("img").attr("src"),this.template({url:url})},setup:function(){this.hasData()||(this.$(".villain-video-block").hide(),videoSetup=$(['<div class="villain-video-setup-icon">','<i class="fa fa-video-camera"></i>',"<div>Lim inn link til youtube eller vimeo, f.eks http://www.youtube.com/watch?v=jlbunmCbTBA</div>","</div>",'<div class="villain-video-setup-input-wrapper">','<input type="text" name="villain-video-setup-url" class="villain-video-setup-url" />',"</div>","<div><hr></div>",'<div style="text-align: center;"><button>Hent video</button></div>'].join("\n")),this.$setup.append(videoSetup),this.$setup.show())}},{getButton:function(e){var i="video";return(t=_.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-video-camera"></i>',"<p>video</p>","</button>"].join("\n")))({id:e,type:i})}}),Villain.Blocks.Map=Villain.Block.extend({type:"map",providers:{gmaps:{regex:/\<iframe(?:.*)src="(.*?)"/,html:['<iframe src="{{protocol}}{{embed_url}}" ','        width="600" ','        height="450" ','        frameborder="0" ','        style="border:0" ',"        allowfullscreen></iframe>"].join("\n")}},template:_.template('<div class="villain-map-block villain-content"><%= content %></div>'),events:{"click .villain-setup-block button":"onClick"},onClick:function(t){t.preventDefault(),mapUrl=this.$(".villain-map-setup-url").val(),embedString=this.buildString(mapUrl),embedString&&(this.$content.html(embedString),this.hideSetup())},buildString:function(t){var e,i={};if(_.each(this.providers,function(a,n){e=a.regex.exec(t),null===e||_.isUndefined(e[1])||(i={source:n,embed_url:e[1]},i.embed_url=i.embed_url.replace("http:","").replace("https:",""),this.setData(i))},this),!i.hasOwnProperty("source"))return void alert("Feil format på embed.");if(this.providers.hasOwnProperty(i.source)){var a=this.providers[i.source].html.replace("{{protocol}}",window.location.protocol).replace("{{embed_url}}",i.embed_url).replace("{{width}}","100%");return a}},initialize:function(t,e){Villain.Block.prototype.initialize.apply(this,[t,e]),_.extend(this.events,Villain.Block.prototype.events)},renderEditorHtml:function(){if(this.providers.hasOwnProperty(this.data.source)){var t=this.providers[this.data.source].html.replace("{{protocol}}",window.location.protocol).replace("{{embed_url}}",this.data.embed_url).replace("{{width}}","100%");return blockTemplate=this.template({content:t}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})}},renderEmpty:function(){return blockTemplate=this.template({content:""}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return url=this.$("img").attr("src"),json={type:this.type,data:this.data}},getHTML:function(){return url=this.$("img").attr("src"),this.template({url:url})},setup:function(){this.hasData()||(this.$(".villain-map-block").hide(),mapSetup=$(['<div class="villain-map-setup-icon">','<i class="fa fa-map-marker"></i>',"<div>Lim inn embed-link fra Google Maps</div>","</div>",'<div class="villain-map-setup-input-wrapper">','<input type="text" name="villain-map-setup-url" class="villain-map-setup-url" />',"</div>","<div><hr></div>",'<div style="text-align: center;"><button>Hent kart</button></div>'].join("\n")),this.$setup.append(mapSetup),this.$setup.show())}},{getButton:function(e){var i="map";return(t=_.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-map-marker"></i>',"<p>map</p>","</button>"].join("\n")))({id:e,type:i})}}),Villain.Blocks.Html=Villain.Block.extend({type:"html",template:_.template('<div class="villain-html-block villain-content"><textarea><%= content %></textarea></div>'),initialize:function(t,e){Villain.Block.prototype.initialize.apply(this,[t,e]),_.extend(this.events,Villain.Block.prototype.events)},_propTextarea:function(){console.log("prop change")},_inputTextarea:function(t){console.log(t)},afterRenderCallback:function(){this.$("textarea").autogrow({onInitialize:!0,fixMinHeight:!0})},renderEditorHtml:function(){return blockTemplate=this.renderContentBlockHtml(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderContentBlockHtml:function(){return text=this.getTextBlockInner()?this.getTextBlockInner():this.data.text,this.template({content:text})},renderEmpty:function(){return blockTemplate=this.template({content:"<p>Text</p>"}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return textNode=this.$("textarea").val(),data=this.getData(),json={type:this.type,data:{text:textNode}}},getHTML:function(){return textNode=this.$("textarea").val()}},{getButton:function(e){var i="html";return(t=_.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-code"></i>',"<p>html</p>","</button>"].join("\n")))({id:e,type:i})}}),Villain.Blocks.Markdown=Villain.Block.extend({type:"markdown",template:_.template('<div class="villain-md-block villain-content"><textarea><%= content %></textarea></div>'),initialize:function(t,e){Villain.Block.prototype.initialize.apply(this,[t,e]),_.extend(this.events,Villain.Block.prototype.events)},afterRenderCallback:function(){this.$("textarea").autogrow({onInitialize:!0,fixMinHeight:!0})},renderEditorHtml:function(){return blockTemplate=this.renderContentBlockHtml(),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},renderContentBlockHtml:function(){return text=this.getTextBlockInner()?this.getTextBlockInner():this.data.text,this.template({content:text})},renderEmpty:function(){return blockTemplate=this.template({content:"Markdown"}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate})},getJSON:function(){return textNode=this.$("textarea").val(),data=this.getData(),json={type:this.type,data:{text:textNode}}},getHTML:function(){return textNode=this.$("textarea").val()}},{getButton:function(e){var i="markdown";return(t=_.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-code"></i>',"<p>markdown</p>","</button>"].join("\n")))({id:e,type:i})}}),Villain.Blocks.Columns=Villain.Block.extend({type:"columns",template:_.template('<div id="villain-column-row-<%= columnId %>" class="row"></div>'),columnTemplate:_.template('<div class="<%= columnClass %>"></div>'),events:{},initialize:function(t,e){Villain.Block.prototype.initialize.apply(this,[t,e]),_.extend(this.events,Villain.Block.prototype.events)},deleteBlock:function(){Villain.BlockStore.hasOwnProperty(this.store)&&Villain.BlockStore.delStore(this.store),Villain.BlockStore.del("main",this.dataId),this.destroy()},renderBlock:function(t){return t.$parent?void(t.$parent.attr("id")===this.$el.attr("id")&&this.$el.append(t.el)):!1},render:function(){return Villain.BlockStore.create(this.id),this.store=this.id,this.$el.attr("data-blockstore",this.store),blockTemplate=this.template({columnId:this.dataId}),actionsTemplate=this.actionsTemplate(),wrapperTemplate=this.wrapperTemplate({content:blockTemplate,actions:actionsTemplate}),this.el.innerHTML=wrapperTemplate,this.$inner=this.$(".villain-block-inner"),this.$content=this.$(".row"),this.data?this.renderEditorHtml():this.renderEmpty(),this.setup&&(this.$inner.prepend(this.setupTemplate()),this.$setup=this.$(".villain-setup-block"),this.setup()),this},renderEditorHtml:function(){this.parseRow(this.getRow());{var t=this.template({columnId:this.dataId}),e=this.actionsTemplate();this.wrapperTemplate({content:t,actions:e})}return this},renderEmpty:function(){{var t=this.template({columnId:this.dataId}),e=this.actionsTemplate();this.wrapperTemplate({content:t,actions:e})}return this},getRow:function(){return this.$row?this.$row:(this.$row=this.$("#villain-column-row-"+this.dataId),this.$row)},getColumns:function(t){return this.getRow().children(t)},getColumn:function(t){return this.getRow().children(":eq("+t+")")},parseRow:function(t){return this.createColumns(t,this.data,this.store)},createColumns:function(t,e,i){for(var a=0;a<=e.length-1;a++){var n=new Villain.Plus(i),l=e[a].class,o=e[a].data,r=$('<div class="'+l+'"></div>');t.append(r),r=t.children(":eq("+a+")"),r.append(n.$el);for(var s=0;s<o.length;s++)if((BlockClass=Villain.BlockRegistry.getBlockClassByType(o[s].type))!==!1){var c=new BlockClass(o[s].data,i);r.append(c.$el),n=new Villain.Plus(i),r.append(n.$el)}}return t},getJSON:function(){return this.parseColumns(this.getColumns())},parseColumns:function(t){var e=this,i={type:this.type,data:[]};return t.each(function(){var t=e.parseBlocks(this);i.data.push({"class":$(this).attr("class"),data:t})}),i},parseBlocks:function(t){var e=[],i=this;return $(t).children(".villain-block-wrapper").each(function(){var t=i.parseBlock(this);e.push(t)}),e},parseBlock:function(t){if("columns"==$(t).attr("data-block-type")){var e=$(t).attr("data-block-id"),i=$("#villain-column-row-"+e,$(t)).children();return this.parseColumns(i)}var a=$(t).attr("data-blockstore"),n=$(t).attr("data-block-id"),l=Villain.BlockStore.getBlockById(a,n),o=l.getJSON();return o},parseCol:function(){},setup:function(){var t=this;this.hasData()?this.$setup.hide():(this.getRow().hide(),this.$setup.append(['<label for="villain-columns-number">Antall kolonner</label>','<input type="text" id="villain-columns-number-'+this.dataId+'" class="villain-columns-number" name="villain-columns-number" />'].join("\n")),this.$setup.on("keyup","input#villain-columns-number-"+this.dataId,function(e){t.updateColumnCount(e)}),this.$setup.show(),this.$(".villain-columns-number").attr("autofocus","autofocus"))},updateColumnCount:function(t){var e=this,i=$(t.target).val();this.$(".villain-column-widths").remove(),columnCountWrapper=$('<div class="villain-column-widths" />');for(var a=1;a<parseInt(i)+1;a++)columnCountWrapper.append(['<label for="villain-column-width-'+a+'">Kolonne '+a+" klassenavn (one, two, three ...)</label>",'<input type="text" name="villain-column-width-'+a+'" class="villain-column-width" />'].join("\n"));columnCountWrapper.append('<button id="villain-columns-apply-'+this.dataId+'" class="villain-columns-apply">Sett opp kolonner</button>'),this.$setup.append(columnCountWrapper),this.$setup.on("click","button#villain-columns-apply-"+this.dataId,function(t){e.applyColumnCount(t)})},applyColumnCount:function(t){t.preventDefault(),columnCount=this.$("input#villain-columns-number-"+this.dataId).val();for(var e=1;e<parseInt(columnCount)+1;e++)columnClass=this.$('input[name="villain-column-width-'+e+'"]').val(),this.getRow().append(this.columnTemplate({columnClass:columnClass})),addblock=new Villain.Plus(this.store),this.getColumn(e-1).append(addblock.$el);this.$setup.hide(),this.getRow().show()},onSetupClick:function(t){t.stopPropagation(),$button=this.$(".villain-action-button-setup"),$button.hasClass("active")?($button.removeClass("active"),this.hideSetup()):($button.addClass("active"),this.showSetup())},renderPlus:function(){return addblock=new Villain.Plus("main")}},{getButton:function(e){var i="columns";return(t=_.template(['<button class="villain-block-button" data-type="<%= type %>" data-after-block-id="<%= id %>">','<i class="fa fa-columns"></i>',"<p>cols</p>","</button>"].join("\n")))({id:e,type:i})}});var blocks=[];Villain.Editor=Backbone.View.extend({el:"#villain",textArea:"#id_body",data:{},blocks:{},events:{"submit form":"clickSubmit","dragover .villain-droppable":"onDragOverDroppable","dragenter .villain-droppable":"onDragEnterDroppable","dragleave .villain-droppable":"onDragLeaveDroppable","drop .villain-droppable":"onDropDroppable","drop .villain-text-block":"onDropTextblock","click .villain-toggle-source":"onToggleSource"},initialize:function(t){_this=this,this.$textArea=$(t.textArea)||this.textArea,this.sourceMode=!1,this.$textArea.css({width:"100%","min-height":"250px","font-family":"monospace","font-size":"12px","line-height":"20px"});var e=$('<div class="villain-toggle-source"><i class="fa fa-code"></i></div>');e.on("click",this.onToggleSource),e.insertBefore(this.$textArea),Villain.EventBus.on("source:toggle",this.toggleSource,this),$('<div id="villain"></div>').insertAfter(this.$textArea),this.el="#villain",this.$el=$(this.el),this.$textArea.hide(),this.isDirty=!1;try{this.data=JSON.parse(this.$textArea.val())}catch(i){this.data=null}$("form").submit(function(){_this.$textArea.val(_this.getJSON())}),Villain.BlockStore.create("main"),Villain.setOptions(t),Villain.BlockRegistry.initialize(t.defaultBlocks,t.extraBlocks),this.render()},render:function(){var t=new Villain.Plus("main");if(this.$el.append(t.$el),formatPopUp=new Villain.FormatPopUp,this.$el.append(formatPopUp.$el),!this.data)return!1;for(var e=0;e<=this.data.length-1;e++)blockJson=this.data[e],(BlockClass=Villain.BlockRegistry.getBlockClassByType(blockJson.type))!==!1?(block=new BlockClass(blockJson.data),this.$el.append(block.$el),this.$el.append(block.renderPlus().$el)):console.error("Villain: No class found for type: "+blockJson.type)},onToggleSource:function(){console.log("toggle"),Villain.EventBus.trigger("source:toggle")},toggleSource:function(){if(this.sourceMode){this.$textArea.hide(),this.$el.show(),this.sourceMode=!1;try{this.data=JSON.parse(this.$textArea.val())}catch(t){this.data=null}this.$el.html(""),this.render()}else this.$textArea.val(this.getJSON()),this.$textArea.show(),this.$el.hide(),this.sourceMode=!0},organizeMode:function(){$(".villain-block-wrapper").toggleClass("organize"),$('.villain-block-wrapper[data-block-type="columns"]').removeClass("organize"),$(".organize .villain-content").hide()},getJSON:function(){var t=[];return this.$(".villain-block-wrapper").each(function(){(block=Villain.BlockStore.getBlockById("main",$(this).data("block-id")))!==!1&&(blockJson=block.getJSON(),t.push(blockJson))}),ret=JSON.stringify(t),"[]"!=ret?ret:""},onDragEnterDroppable:function(t){$(".villain-add-block-button",t.currentTarget).addClass("drop-hover"),t.preventDefault(),t.stopPropagation()},onDragLeaveDroppable:function(t){$(".villain-add-block-button",t.currentTarget).removeClass("drop-hover"),t.preventDefault(),t.stopPropagation()},onDragOverDroppable:function(t){t.preventDefault(),t.stopPropagation()},onDropDroppable:function(t){return target=t.currentTarget,$(target).hasClass("villain-droppable")!==!0?(t.preventDefault(),t.stopPropagation(),!1):($(".villain-add-block-button",target).removeClass("drop-hover"),sourceId=t.originalEvent.dataTransfer.getData("text/plain"),$source=$("[data-block-id="+sourceId+"]"),$sourceAdd=$source.next(),$source.detach(),$sourceAdd.detach(),$source.insertAfter($(target)),oldBlockStore=$source.attr("data-blockstore"),newBlockStore=$(target).attr("data-blockstore"),block=Villain.BlockStore.getBlockById(oldBlockStore,sourceId),block.store=newBlockStore,Villain.BlockStore.del(oldBlockStore,sourceId),Villain.BlockStore.add(newBlockStore,sourceId,block),$source.attr("data-blockstore",newBlockStore),$sourceAdd.insertAfter($source),void $sourceAdd.attr("data-blockstore",newBlockStore))},onDropTextblock:function(t){return $target=$(t.currentTarget).closest(".villain-block-wrapper").shake(),t.preventDefault(),t.stopPropagation(),!1},clickSubmit:function(t){Villain.EventBus.trigger("posts:submit",t),form=this.checkForm(),form.valid===!1&&t.preventDefault(),window.onbeforeunload=$.noop()},checkForm:function(){var t={valid:!0,errors:[]};return""===$titleEl.val()&&(t.errors.push("Overskrift kan ikke være blank."),t.valid=!1,$titleEl.parent().parent().addClass("error"),$titleEl.parent().parent().append('<span class="help-inline"><strong><i class="icon-hand-up"></i> Feltet er påkrevet.</strong></span>'),$("html, body").animate({scrollTop:0},5)),t},markDirty:function(){this.isDirty=!0}}),Villain.FormatPopUp=Backbone.View.extend({tagName:"div",className:"villain-format-popup",events:{"click .villain-format-bold":"onClickBold","click .villain-format-italic":"onClickItalic","click .villain-format-link":"onClickLink","click .villain-format-unlink":"onClickUnlink"},onClickBold:function(t){t.preventDefault(),document.execCommand("bold",!1,!1),this.activateButton(".villain-format-bold")},onClickItalic:function(t){t.preventDefault(),document.execCommand("italic",!1,!1),this.activateButton(".villain-format-italic")},onClickLink:function(t){t.preventDefault();var e=prompt("Insert link:");e&&e.length>0&&(document.execCommand("CreateLink",!1,e),this.activateButton(".villain-format-link"))},onClickUnlink:function(t){t.preventDefault(),document.execCommand("unlink",!1,!1)},initialize:function(){this.render(),Villain.EventBus.on("formatpopup:show",this.showPopUp,this),Villain.EventBus.on("formatpopup:hide",this.hidePopUp,this)},render:function(){return this.$el.append('<button class="popup-button villain-format-bold"><i class="fa fa-bold"></i></button>'),this.$el.append('<button class="popup-button villain-format-italic"><i class="fa fa-italic"></i></button>'),this.$el.append('<button class="popup-button villain-format-link"><i class="fa fa-link"></i></button>'),this.$el.append('<button class="popup-button villain-format-unlink"><i class="fa fa-unlink"></i></button>'),this},showPopUp:function(t){$el=t.$el;var e=window.getSelection(),i=e.getRangeAt(0),a=i.getBoundingClientRect(),n=$el.offset(),l={};mainContent=$("section#maincontent"),l.top=a.top+mainContent.scrollTop(),l.left=(a.left+a.right)/2-this.$el.width()/2-n.left+12,parseInt(l.left)<0&&(l.left="0"),l.left=l.left+"px",this.deactivateButtons(),this.activeButtons(),this.$el.addClass("show-popup"),this.$el.css(l)},hidePopUp:function(){this.$el.removeClass("show-popup")},activeButtons:function(){var t,e=window.getSelection();e.rangeCount>0&&(t=e.getRangeAt(0).startContainer.parentNode),t&&"A"==t.nodeName&&this.activateButton(".villain-format-link"),document.queryCommandState("bold")&&this.activateButton(".villain-format-bold"),document.queryCommandState("italic")&&this.activateButton(".villain-format-italic")},activateButton:function(t){this.$(t).addClass("active")},deactivateButtons:function(){this.$(".popup-button").removeClass("active")}}),Villain.Editor.HTML=Villain.Editor.HTML||{},Villain.Editor.EditorHTML=Villain.Editor.EditorHTML||{},Villain.toMD=function(t){var t=toMarkdown(t);return t=t.replace(/&nbsp;/g," "),t=t.replace(/([^<>]+)(<div>)/g,"$1\n$2").replace(/<div><div>/g,"\n<div>").replace(/<div><br \/><\/div>/g,"\n\n").replace(/(?:<div>)([^<>]+)(?:<div>)/g,"$1\n").replace(/(?:<div>)(?:<br>)?([^<>]+)(?:<br>)?(?:<\/div>)/g,"$1\n").replace(/<\/p>/g,"\n\n").replace(/<(.)?br(.)?>/g,"\n").replace(/&lt;/g,"<").replace(/&gt;/g,">"),aggressiveStrip=!0,t=aggressiveStrip?t.replace(/<\/?[^>]+(>|$)/g,""):t.replace(/<(?=\S)\/?[^>]+(>|$)/gi,"")},Villain.toHTML=function(t,e){if(_.isUndefined(t))return"";e=_.classify(e);var i=t,a="Text"===e;_.isUndefined(a)&&(a=!1),a&&(i="<div>"+i),i=i.replace(/\[([^\]]+)\]\(([^\)]+)\)/gm,function(t,e,i){return'<a href="'+i+'">'+e.replace(/\r?\n/g,"")+"</a>"}),i=_.reverse(_.reverse(i).replace(/_(?!\\)((_\\|[^_])*)_(?=$|[^\\])/gm,function(t,e){return">i/<"+e.replace(/\r?\n/g,"").replace(/[\s]+$/,"")+">i<"}).replace(/\*\*(?!\\)((\*\*\\|[^\*\*])*)\*\*(?=$|[^\\])/gm,function(t,e){return">b/<"+e.replace(/\r?\n/g,"").replace(/[\s]+$/,"")+">b<"})),i=i.replace(/^\> (.+)$/gm,"$1");var n,l;for(n in Villain.Formatters)Villain.Formatters.hasOwnProperty(n)&&(l=Villain.Formatters[n],!_.isUndefined(l.toHTML)&&_.isFunction(l.toHTML)&&(i=l.toHTML(i)));return a&&(i=i.replace(/\r?\n\r?\n/gm,"</div><div><br></div><div>").replace(/\r?\n/gm,"</div><div>")),i=i.replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;").replace(/\r?\n/g,"<br>").replace(/\*\*/,"").replace(/__/,""),i=i.replace(/\\\*/g,"*").replace(/\\\[/g,"[").replace(/\\\]/g,"]").replace(/\\\_/g,"_").replace(/\\\(/g,"(").replace(/\\\)/g,")").replace(/\\\-/g,"-"),a&&(i+="</div>"),i},Villain.setOptions=function(t){(_.isUndefined(t.imageSeries)||_.isUndefined(t.baseURL))&&console.error("Villain: baseURL and imageSeries MUST be set on initialization."),Villain.defaults.browseURL=t.baseURL+Villain.defaults.browseURL+t.imageSeries,Villain.defaults.uploadURL=t.baseURL+Villain.defaults.uploadURL+t.imageSeries,Villain.defaults.imageseriesURL=t.baseURL+Villain.defaults.imageseriesURL,Villain.options=$.extend({},Villain.defaults,t)},Villain.browser=function e(){var e={};if(this.getIEversion()>0)e.msie=!0;else{var t=navigator.userAgent.toLowerCase(),i=/(chrome)[ \/]([\w.]+)/.exec(t)||/(webkit)[ \/]([\w.]+)/.exec(t)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(t)||/(msie) ([\w.]+)/.exec(t)||t.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(t)||[],a={browser:i[1]||"",version:i[2]||"0"};i[1]&&(e[a.browser]=!0),parseInt(a.version,10)<9&&e.msie&&(e.oldMsie=!0),e.chrome?e.webkit=!0:e.webkit&&(e.safari=!0)}return e},Villain.Editor.processPaste=function(t){var e;return t.match(/(class=\"?Mso|style=\"[^\"]*\bmso\-|w:WordDocument)/gi)?(e=Villain.Editor.wordClean(t),e=Villain.Editor.clean($("<div>").append(e).html(),!1,!0),e=Villain.Editor.removeEmptyTags(e)):(e=Villain.Editor.clean(t,!1,!0),e=Villain.Editor.removeEmptyTags(e)),e=Villain.Editor.plainPasteClean(e),""!==e?e:void 0},Villain.Editor.wordClean=function(t){t.indexOf("<body")>=0&&(t=t.replace(/[.\s\S\w\W<>]*<body[^>]*>([.\s\S\w\W<>]*)<\/body>[.\s\S\w\W<>]*/g,"$1")),t=t.replace(/<p(.*?)class="?'?MsoListParagraph"?'?([\s\S]*?)>([\s\S]*?)<\/p>/gi,"<ul><li><p>$3</p></li></ul>"),t=t.replace(/<p(.*?)class="?'?MsoListParagraphCxSpFirst"?'?([\s\S]*?)>([\s\S]*?)<\/p>/gi,"<ul><li><p>$3</p></li>"),t=t.replace(/<p(.*?)class="?'?MsoListParagraphCxSpMiddle"?'?([\s\S]*?)>([\s\S]*?)<\/p>/gi,"<li><p>$3</p></li>"),t=t.replace(/<p(.*?)class="?'?MsoListParagraphCxSpLast"?'?([\s\S]*?)>([\s\S]*?)<\/p>/gi,"<li><p>$3</p></li></ul>"),t=t.replace(/<span([^<]*?)style="?'?mso-list:Ignore"?'?([\s\S]*?)>([\s\S]*?)<span/gi,"<span><span"),t=t.replace(/<!--\[if \!supportLists\]-->([\s\S]*?)<!--\[endif\]-->/gi,""),t=t.replace(/(\n|\r| class=(")?Mso[a-zA-Z]+(")?)/gi," "),t=t.replace(/<!--[\s\S]*?-->/gi,""),t=t.replace(/<(\/)*(meta|link|span|\\?xml:|st1:|o:|font)(.*?)>/gi,"");for(var e=["style","script","applet","embed","noframes","noscript"],i=0;i<e.length;i++){var a=new RegExp("<"+e[i]+".*?"+e[i]+"(.*?)>","gi");t=t.replace(a,"")}t=t.replace(/([\w\-]*)=("[^<>"]*"|'[^<>']*'|\w+)/gi,""),t=t.replace(/&nbsp;/gi,"");var n;do n=t,t=t.replace(/<[^\/>][^>]*><\/[^>]+>/gi,"");while(t!=n);return t=Villain.Editor.clean(t)},Villain.Editor.clean=function(t,e,i,a,n){n=["accept","accept-charset","accesskey","action","align","alt","async","autocomplete","autofocus","autoplay","autosave","background","bgcolor","border","charset","cellpadding","cellspacing","checked","cite","class","color","cols","colspan","contenteditable","contextmenu","controls","coords","data","data-.*","datetime","default","defer","dir","dirname","disabled","download","draggable","dropzone","enctype","for","form","formaction","headers","height","hidden","high","href","hreflang","icon","id","ismap","itemprop","keytype","kind","label","lang","language","list","loop","low","max","maxlength","media","method","min","multiple","name","novalidate","open","optimum","pattern","ping","placeholder","poster","preload","pubdate","radiogroup","readonly","rel","required","reversed","rows","rowspan","sandbox","scope","scoped","scrolling","seamless","selected","shape","size","sizes","span","src","srcdoc","srclang","srcset","start","step","summary","spellcheck","style","tabindex","target","title","type","translate","usemap","value","valign","width","wrap"],a=["!--","a","abbr","address","area","article","aside","audio","b","base","bdi","bdo","blockquote","br","button","canvas","caption","cite","code","col","colgroup","datalist","dd","del","details","dfn","dialog","div","dl","dt","em","embed","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","hr","i","iframe","img","input","ins","kbd","keygen","label","legend","li","link","main","map","mark","menu","menuitem","meter","nav","noscript","object","ol","optgroup","option","output","p","param","pre","progress","queue","rp","rt","ruby","s","samp","script","section","select","small","source","span","strong","style","sub","summary","sup","table","tbody","td","textarea","tfoot","th","thead","time","title","tr","track","u","ul","var","video","wbr"],t=t.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,"");var l=new RegExp("<\\/?((?!(?:"+a.join("|")+"))\\w+)[^>]*?>","gi");t=t.replace(l,"");var o=new RegExp("( (?!(?:"+n.join("|")+"))[a-zA-Z0-9-_]+)=((?:.(?!\\s+(?:\\S+)=|[>]|(\\/>)))+.)","gi");t=t.replace(o,"");var r=new RegExp("style=(\"[a-zA-Z0-9:;\\.\\s\\(\\)\\-\\,!\\/'%]*\"|'[a-zA-Z0-9:;\\.\\s\\(\\)\\-\\,!\\/\"%]*')","gi");t=t.replace(r,"");var s=$("<div>").append(t);return s.find('[class]:not([class^="fr-"])').each(function(t,e){$(e).removeAttr("class")}),t=s.html()},Villain.Editor.plainPasteClean=function(t){var e=$("<div>").html(t);e.find("h1, h2, h3, h4, h5, h6, pre, blockquote").each(function(t,e){$(e).replaceWith("<p>"+$(e).html()+"</p>")});for(var i=function(t,e){$(e).replaceWith($(e).html())};e.find("strong, em, strike, b, u, i, sup, sub, span, a").length;)e.find("strong, em, strike, b, u, i, sup, sub, span, a").each(i);return e.html()},Villain.Editor.removeEmptyTags=function(t){for(var e,i=$("<div>").html(t),a=i.find("*:empty:not(br, img, td, th)");a.length;){for(e=0;e<a.length;e++)$(a[e]).remove();a=i.find("*:empty:not(br, img, td, th)")}i.find("> div").each(function(t,e){$(e).replaceWith($(e).html()+"<br/>")});for(var n=i.find("div");n.length;){for(e=0;e<n.length;e++){var l=$(n[e]),o=l.html().replace(/\u0009/gi,"").trim();l.replaceWith(o)}n=i.find("div")}return i.html()},Villain.Editor.pasteHtmlAtCaret=function(t){var e,i;if(window.getSelection){if(e=window.getSelection(),e.getRangeAt&&e.rangeCount){i=e.getRangeAt(0),i.deleteContents();var a=document.createElement("div");a.innerHTML=t;for(var n,l,o=document.createDocumentFragment();n=a.firstChild;)l=o.appendChild(n);i.insertNode(o),l&&(i=i.cloneRange(),i.setStartAfter(l),i.collapse(!0),e.removeAllRanges(),e.addRange(i))}}else document.selection&&"Control"!=document.selection.type&&document.selection.createRange().pasteHTML(t)},Villain.BlockRegistry={},Villain.BlockRegistry.initialize=function(t,e){Villain.BlockRegistry.Map=_.isUndefined(t)?["Text","Header","Blockquote","List","Image","Slideshow","Video","Map","Divider","Html","Markdown","Columns"]:t,_.isUndefined(e)||Villain.BlockRegistry.addExtraBlocks(e),Villain.BlockRegistry.checkBlocks()},Villain.BlockRegistry.addExtraBlocks=function(t){Villain.BlockRegistry.Map=Villain.BlockRegistry.Map.concat(t)},Villain.BlockRegistry.add=function(t){Villain.BlockRegistry.Map.push(t)},Villain.BlockRegistry.checkBlocks=function(){for(i=0;i<Villain.BlockRegistry.Map.length;++i)type=Villain.BlockRegistry.Map[i],_.isUndefined(Villain.Blocks[_(type).capitalize()])&&console.error("Villain: Missing block source for "+type+"! Please ensure it is included.")},Villain.BlockRegistry.getBlockClassByType=function(t){return-1!==Villain.BlockRegistry.Map.indexOf(_(t).capitalize())?Villain.Blocks[_(t).capitalize()]:!1};